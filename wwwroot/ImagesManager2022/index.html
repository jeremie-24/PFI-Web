<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout">
                <div class="creditDiv" id="creditCmd" title="À propos" data-toggle="tooltip">
                    <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon"
                        title="Gestionnaire d'images">
                </div>
                <div style="display:flex">
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>

                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image"
                    data-toggle="tooltip"></span>
                <span id="Date_Asc" class="cmd fa-solid fa-arrow-down-wide-short"></span>
                <span id="Date_Desc" class="cmd fa-solid fa-arrow-down-short-wide"></span>
                <span id="SearchCmd" class="cmd fa fa-search" title="Afficher/masquer la barre de recherche" data-toggle="tooltip"></span>
                <span class="cmd fa fa-user-plus loginDiv" id="newUserCmd" title="Créer un compte"
                    data-toggle="tooltip"></span>




            </div>
            <div class="rightHeaderLayout">

                <div class="loggedDiv">
                    <span id="modifyUserCmd"><img id="userImage" src="" alt="Image_user"></span>
                    <span id="usernameContainer">Nom</span>
                </div>
                <span class="cmd fa-solid fa-right-to-bracket loginDiv" id="loginCmd" title="Se connecter"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-sign-out loggedDiv" id="logoutCmd" title="Se déconnecter"
                    data-toggle="tooltip"></span>
            </div>
        </div>

        <div id="searchBar">
            <div class="searchBarLayout">
                <select id="searchUserName" class="form-control searchInput">
                    <!-- filled programmatically-->
                </select>
                <span>
                    <!-- skip a column -->
                </span>
                <input type="search" id="searchTitle" class="form-control searchInput"
                    placeholder="Recherche de nouvelles" />
                <span>
                    <!-- skip a column -->
                </span>
                <span id="RefreshCmd" class="cmd fa fa-refresh"></span>
            </div>
        </div>

        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
            <div>
                <div id="imageDlg">
                    <form id="imageForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="">

                        <label for="title_input">Titre</label>
                        <input type="text" id="title_input" class="form-control" required>

                        <label for="decription_input">Description</label>
                        <textarea id="description_input" class="form-control" required></textarea>

                        <label for="image">Image</label>
                        <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez une image</div>

                        <input type="checkbox" name="shared_input" id="shared_input" checked>
                        <label for="shared_input">Partager</label>
                    </form>
                </div>

                <div id="imageInfosDlg">
                    <form id="imageForm">
                        <span>Titre: </span>
                        <span id="image_title"></span>

                        <br>

                        <span>Description: </span>
                        <span id="image_description"></span>

                        <br>

                        <a id="image_lien" href="" target="_blank"><img id="image_image" src="" alt="Image"></a>

                        <br>

                        <span>Date de publication: </span>
                        <span id="image_date"></span>

                        <br>

                        <span>Auteur: </span>
                        <span id="image_username"></span>

                        <br>

                        <img id="image_avatar" src="" alt="Avatar de l'utilisateur">
                    </form>
                </div>


                <div id="userDlg">
                    <form id="userForm">
                        <input type="hidden" id="Id_user_input" value="0">
                        <input type="hidden" id="avatar_GUID_input" value="">

                        <!--<label for="username_input">Nom d'usager</label>-->
                        <input type="text" id="username_input" class="form-control userInput" placeholder="Nom d'usager"
                            required>


                        <!--<label for="email_input ">Courriel</label>-->
                        <input type="text" id="email_input" class="form-control Email userInput" placeholder="Courriel"
                            required>

                        <!--<label for="password_input">Mot de passe</label>-->
                        <input type="password" id="password_input" placeholder="Mot de passe"
                            class="form-control MatchedPassword userInput" matchedPasswordId="passwordConfirm_input"
                            required oninvalid="this.setCustomValidity('')">

                        <!--<label for="passwordConfirm_input">Confirmation</label>-->
                        <input type="password" id="passwordConfirm_input" placeholder="Confirmation "
                            class="form-control userInput">

                        <label for="avatar">Avatar</label>
                        <div id='avatar' class='ImageUploader' defaultImage='images/No_Avatar.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez votre avatar</div>
                    </form>
                </div>

                <div id="loginDlg">
                    <form id="loginForm">
                        <label for="email_input">Courriel</label>
                        <input type="text" id="email_input_login" class="form-control" required>

                        <label for="password_input">Mot de passe</label>
                        <input type="password" id="password_input_login" class="form-control" required>

                        <input type="checkbox" name="remember_input" id="remember_input">
                        <label for="remember_input">Se souvenir de moi</label>
                    </form>
                </div>


                <div id="verifyCodeDlg">
                    <form id="verifyCodeForm">
                        Consultez votre boîte de courriel pour connaître votre code de vérification et
                        inscrivez-le-ci-dessous.

                        <input type="text" placeholder="Code de vérification" id="verify_code_input"
                            class="form-control" required>


                    </form>
                </div>

                <div id="logoutDlg">
                    <form id="logoutForm">
                        <p>Voulez-vous vraiement vous déconnecter?</p>
                    </form>
                </div>


                <div id="confirmDeleteDlg">
                    <span id="confirmationMessage"></span>
                </div>
                <div id="confirmDeleteUserDlg">
                    <span id="confirmationUserMessage">Voulez-vous vraiment effacer votre compte?</span>
                </div>
                <div id="errorDlg">
                    <span id="errorMessage"></span>
                </div>

                <div id="creditDlg">
                    <div>Jérémie Couturier</div>
                    <div>Marc-Antoine Duquette</div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/api.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            const userSessionStorageName = "user";
            const loginLocalStorageName = "login";
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let searchUserName = "";
            let searchTitle = "";
            let hideSearchBar = true;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let selectedUserName = "";
            let imagesCount = 50;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let token;
            let user;
            let userToken;
            let searchBarIsShown = false;
            let dateSort = "desc";

            let userCreateMode = true;

            init_UI();
            initToken();

            HEAD(checkETag, error);
            setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

            function checkETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    getImagesList();
                }
            }

            function getImagesList(refresh = true) {
                appendMode = !refresh;
                GETUSERNAMES(DisplayUserNames, error);
                
                function prepareQueryString() {
                    let queryString = "";
                    let dateSortString = "sort=Date," + dateSort;
                    if (appendMode) {
                        queryString = `?${dateSortString}&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                        imagesCount += appendCount;
                    } else {
                        queryString = `?${dateSortString}sort=Date,desc&offset=${0}&limit=${imagesCount}`;
                    }
                    if (searchBarIsShown) {
                        selectedUserId = $("#searchUserName").val();
                        let searchTitle = $("#searchTitle").val();
                        if (selectedUserId != "")
                            queryString += "&UserId=" + selectedUserId;
                            //TODO ajouter les keywords
                    }
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
            }

            function updateUser(data) {
                if (data == user) {
                    return;
                }

                user = data;
                //userToForm(data);
                sessionStorage.setItem(userSessionStorageName, JSON.stringify(user));
                $("#userImage").attr("src", data.AvatarURL);
                $("#usernameContainer").html(getUserNameSpan(data));

                getImagesList();

                /*
                let login = getLoginFromUser(data);
                updateRememberMe(login);
                */
                ResetSearchBar();
            }
            function isVerified(user) {
                return user.VerifyCode == "verified";
            }
            function getUserNameSpan(currentUser) {
                let span = $("<span></span>")
                span.append(currentUser.Name);
                if (!isVerified(currentUser)) {
                    span.addClass("unverifiedName");
                    span.click(() => $("#verifyCodeDlg").dialog('open'));
                    span.attr("data-toggle", "tooltip");
                    span.attr("title", "Votre compte n'est pas vérifié. Cliquer sur votre nom pour ouvrir le menu de confirmation de courriel.");
                }
                return span;
            }
            function updateRememberMe(login) {
                if (localStorage.hasOwnProperty('login')) {
                    let newLogin = JSON.parse(window.localStorage.getItem("login"));
                    if (login.Password) {
                        newLogin.Password = login.Password;
                    }
                    if (login.Email) {
                        newLogin.Email = login.Email;
                    }
                    window.localStorage.setItem(loginLocalStorageName, JSON.stringify(newLogin));
                }
            }
            function getLoginFromUser(user) {
                let login =
                {
                    Email: user.Email,
                    Password: user.Password
                }
                return login;

            }
            function getUser(token) {
                GETUSER(token, updateUser, error);
            }

            function showLoginButtons(isLogged) {
                if (isLogged) {
                    $(".loginDiv").hide();
                    $(".loggedDiv").show();
                    if (user && isVerified(user)) {
                        $(".verifiedDiv").show();
                    }
                    else {
                        $(".verifiedDiv").hide();
                    }
                }
                else {
                    $(".loginDiv").show();
                    $(".loggedDiv").hide();
                    $(".verifiedDiv").hide();
                }
            }

            function changeToken(newToken) {
                userToken = newToken;
                token = newToken.Access_token;
                //$("#loginDlg").dialog("close");


                sessionStorage.setItem("token", JSON.stringify(newToken));
                /*
                var isChecked = $("#remember_input").prop('checked');
                sessionStorage.setItem("token", JSON.stringify(newToken));
                if (ihoChecked) {
                    window.localStorage.setItem("token", JSON.stringify(newToken));
                }
                else {
                    console.log("no remember me");
                }
                */
                //rememberMe()

                resetLoginForm();
                getUser(newToken);
                showLoginButtons(true);
                getImagesList(true);
            }
            function rememberMe(login) {
                /*
                let login =
                {
                    Email: $("#email_input_login").val(),
                    Password: $("#password_input_login").val()
                }
                */
                var isChecked = $("#remember_input").is(':checked')

                if (isChecked) {
                    window.localStorage.setItem(loginLocalStorageName, JSON.stringify(login));
                }
                else {
                    window.localStorage.removeItem(loginLocalStorageName);
                }
            }
            function useRememberMe() {
                let loginFromStorage = JSON.parse(window.localStorage.getItem("login"));

                if (loginFromStorage != null) {
                    $("#email_input_login").val(loginFromStorage.Email);
                    $("#password_input_login").val(loginFromStorage.Password);
                    $("#remember_input").prop("checked", true);
                }

            }



            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image) {
                    var imageUrl = image.AvatarURL;
                    var header = "";

                    var isOwned = user && user["Id"] && image.UserId == user.Id

                    if (isOwned) {
                        if (image.Shared) {
                            imageUrl = "images/shared.png";
                        }
                        else {
                            imageUrl = "images/notShared.png"
                        }
                        if (isVerified(user)) {
                            header = `
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>`
                        }

                    }
                    if (image.Shared || isOwned) {
                        $("#imagesList").append(
                            $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                    ${header}
                                    </div>
                                    <a href="${image.OriginalURL}" target="_blank" class="imageContainer">
                                        <img class="avatarOnImage" src="${imageUrl}" alt="" title="Image de ${image.UserName}" 
                                                data-toggle="tooltip">
                                        <div    class='image' 
                                                style="background-image:url('${image.ThumbnailURL}')"
                                                >
                                        </div>
                                    </a>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                        );
                    }

                    $("#image_div_" + image.Id).click(e => { imageDetails(image) });
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {
                    insertIntoImageList(image);
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { editimage(e) });
                $(".deleteCmd").click(e => { deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function imageDetails(image){
                $("#imageInfosDlg").dialog('option', 'title', "Détails de l'image " + image.Title);
                $("#image_title").text(image.Title);
                $("#image_description").text(image.Description);
                $("#image_lien").attr("href", image.OriginalURL);
                $("#image_image").attr("src", image.ThumbnailURL);
                var date = image.Date;
                if (typeof date === "string"){
                    date = parseInt(date.toString());
                }
                $("#image_date").text(new Date(date).toLocaleDateString("fr"));
                $("#image_username").text(image.UserName);
                $("#image_avatar").attr("src", image.AvatarURL);
                $("#imageInfosDlg").dialog("open");
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function newImage() {
                holdCheckETag = true;
                createMode = true;
                resetimageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }
            function credits() {
                holdCheckETag = true;
                $("#creditDlg").dialog('option', 'title', 'À propos');
                $("#creditDlg").dialog('open');
            }
            function logout() {
                holdCheckETag = true;
                $("#logoutDlg").dialog('option', 'title', 'Déconnexion');
                $("#logoutDlgOkBtn").text("Déconnexion");
                $("#logoutDlg").dialog('open');
            }
            function logoutOfAccount(apiRequest = true) {
                sessionStorage.removeItem("token");
                sessionStorage.removeItem(userSessionStorageName);


                if (apiRequest) {
                    LOGOUT(user.Id, () => console.log("Déconnexion"), error);
                }

                resetUserForm();
                showLoginButtons(false);
                getImagesList();
                user = null;
                token = null;
                userToken = null;
            }
            function login() {
                holdCheckETag = true;

                useRememberMe();

                $("#loginDlg").dialog('option', 'title', 'Connexion');
                $("#loginDlgOkBtn").text("Connexion");
                $("#loginDlg").dialog('open');
            }
            function changeLoginToken() {
                let login =
                {
                    Email: $("#email_input_login").val(),
                    Password: $("#password_input_login").val()
                }
                rememberMe(login);
                TOKEN(login, changeToken, error);
            }

            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }
            function editUser(e) {
                holdCheckETag = true;
                userCreateMode = false;

                ImageUploader.imageRequired('avatar', true);
                $("#userDlg").dialog('option', 'title', "Modification du profil");
                $("#userDlgOkBtn").text('Modifier');
                $("#userDlg").dialog('open');

            }
            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                $("#shared_input").prop("checked", true)
                ImageUploader.resetImage('image');
            }
            function resetLoginForm() {
                $("#email_input_login").val("");
                $("#password_input_login").val("");
                $("#remember_input").prop('checked', false);
            }
            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        UserId: JSON.parse(sessionStorage.getItem("token")).UserId,
                        Shared: $("#shared_input").prop("checked")
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }


            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }
            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                $("#shared_input").prop("checked", true);
                ImageUploader.resetImage('image');
            }
            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        UserId: JSON.parse(sessionStorage.getItem("token")).UserId,
                        Shared: $("#shared_input").prop("checked")
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function imageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                $("#date_input").val(image.Date);
                //$("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                ImageUploader.setImage('image', image.OriginalURL);
                //TODO shared?
            }

            function newUser() {
                holdCheckETag = true;
                userCreateMode = true;
                ImageUploader.imageRequired('avatar', true);
                $("#password_input").prop('required', true);
                $("#userDlg").dialog('option', 'title', "Création de compte");
                $("#userDlgDeleteBtn").hide();
                $("#userDlgOkBtn").text('Créer');
                $("#userDlg").dialog('open');
            }
            function modifyUser() {
                holdCheckETag = true;
                userCreateMode = false;
                userToForm(user);
                ImageUploader.imageRequired('avatar', false);
                //TODO régler problème: quand on efface le mot de passe, il est required
                $("#password_input").prop('required', false);
                $("#userDlg").dialog('option', 'title', "Modification de compte");
                $("#userDlgOkBtn").text('Modifier');
                $("#userDlgDeleteBtn").show();
                $("#userDlg").dialog('open');
            }
            function updateAfterModify(modifiedUser) {

                if (modifiedUser.Email != user.Email) {
                    $("#verifyCodeDlg").dialog('open');
                }
                updateUser(modifiedUser);

                let login = getLoginFromUser(modifiedUser);
                updateRememberMe(login);

                getImagesList();
            }


            function userToForm(user) {

                $("#Id_user_input").val(user.Id);
                $("#username_input").val(user.Name);
                $("#email_input").val(user.Email);
                $("#avatar_GUID_input").val(user.AvatarGUID);

                ImageUploader.setImage('avatar', user.AvatarURL);
            }

            function userFromForm() {
                if ($("#userForm")[0].checkValidity()) {
                    let user = {
                        Id: parseInt($("#Id_user_input").val()),
                        Name: $("#username_input").val(),
                        Email: $("#email_input").val(),
                        Password: $("#password_input").val(),
                        ImageData: ImageUploader.getImageData('avatar'),
                        AvatarGUID: $("#avatar_GUID_input").val()
                    };
                    return user;
                } else {
                    $("#userForm")[0].reportValidity()
                }
                return false;
            }

            function verifyCodeFromForm() {
                if ($("#verifyCodeForm")[0].checkValidity()) {
                    let verifyCode = {
                        //Id: parseInt($("#Id_user_input").val()),
                        Id: user.Id,
                        code: parseInt($("#verify_code_input").val()),
                    };
                    return verifyCode;
                } else {
                    $("#verifyCodeForm")[0].reportValidity()
                }
                return false;
            }
            function resetUserForm() {
                $("#Id_user_input").val("0");
                $("#username_input").val("");
                $("#email_input").val("");
                $("#password_input").val("");
                $("#passwordConfirm_input").val("");
                $("#avatar_GUID_input").val("");
                ImageUploader.resetImage('avatar');
            }

            function resetVerifyCodeForm() {
                $("#verify_code_input").val("");
            }

            function firstLogin(newUserData) {
                let login =
                {
                    Email: newUserData.Email,
                    Password: $("#password_input").val()
                }
                resetUserForm();

                TOKEN(login, changeToken, error);
                //resetUserForm();
                $("#verifyCodeDlg").dialog('open');
            }

            function initToken() {
                let tokenFromSession = sessionStorage.getItem("token");
                //let userToken;
                if (tokenFromSession != null) {
                    userToken = JSON.parse(tokenFromSession);
                    if (userToken != null) {
                        token = userToken.Access_token;

                        let userFromSession = sessionStorage.getItem(userSessionStorageName);
                        if (userFromSession != null) {
                            updateUser(JSON.parse(userFromSession));
                        }
                        else {
                            getUser(userToken);
                        }
                        showLoginButtons(true);
                    }
                }


            }

            function DisplayUserNames(names){
                ClearUserNames();
                $("#searchUserName").append(`<option value="">Toutes les images</option>`);
                if (user && user["Id"]){
                    $("#searchUserName").append(`<option value=${user.Id}>Mes images</option>`);
                }
                
                for (let name of names) {
                    if (!user || name.UserId != user.Id){
                        $("#searchUserName").append(`<option value=${name.UserId}>${name.UserName}</option>`);
                    }
                }
            }

            function ClearUserNames(){
                $("#searchUserName").empty();
            }
            
            function ToggleSearchBar(){
                if (searchBarIsShown){
                    $("#searchBar").hide();
                    searchBarIsShown = false;
                }
                else{
                    GETUSERNAMES(DisplayUserNames, error);
                    $("#searchBar").show();
                    searchBarIsShown = true;
                }
            }

            function ResetSearchBar(){
                GETUSERNAMES(DisplayUserNames, error);
            }

            function SwitchDateSort(){
                if (dateSort == "asc"){
                    dateSort = "desc";;
                    $("#Date_Desc").show();
                    $("#Date_Asc").hide();
                }
                else{
                    dateSort = "asc";
                    $("#Date_Desc").hide();
                    $("#Date_Asc").show();
                }
                getImagesList(true);
            }

            function init_UI() {
                $("#Date_Asc").hide();
                $("#searchBar").hide();
                $("#SearchCmd").click(ToggleSearchBar)
                $("#newImageCmd").click(newImage);
                $("#newUserCmd").click(newUser);
                $("#modifyUserCmd").click(modifyUser);
                $("#loginCmd").click(login);
                $("#logoutCmd").click(logout);
                $("#creditCmd").click(credits);
                $("#RefreshCmd").click(e => {getImagesList(true)});
                $("#Date_Desc").click(SwitchDateSort);
                $("#Date_Asc").click(SwitchDateSort);
                //$(".loggedDiv").hide();
                showLoginButtons(false);

                //useRememberMe();

                // Images
                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            if (image) {
                                if (createMode) {
                                    POST(image, token, getImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else
                                    PUT(image, token, getImagesList, error);
                                resetimageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#loginDlg").dialog({
                    title: "Connexion",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 360,
                    minHeight: 360,
                    maxHeight: 360,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "loginDlgOkBtn",
                        text: "Login",
                        click: function () {
                            changeLoginToken();
                            //resetLoginForm();
                            $("#loginDlg").dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#creditDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 200,
                    minHeight: 200,
                    maxHeight: 200,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                })

                $("#logoutDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 200,
                    minHeight: 200,
                    maxHeight: 200,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "logoutDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            /*
                            sessionStorage.removeItem("token");
                            sessionStorage.removeItem(userSessionStorageName);
                            //window.localStorage.setItem("token", token);

                            LOGOUT(user.Id, () => console.log("Déconnexion"), error);
                            resetUserForm();
                            showLoginButtons(false);
                            user = null;
                            token = null;
                            userToken = null;
                            holdCheckETag = false;
                            */
                            logoutOfAccount();
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Non",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                DELETE(imageIdToDelete, token, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#imageInfosDlg").dialog({
                    title: "Informations de l'image",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 700, minHeight: 700, maxHeight: 700,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        getImagesList(false);
                    }
                });


                // users
                $("#userDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500,
                    minWidth: 500,
                    maxWidth: 640,
                    height: 650,
                    minHeight: 650,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [
                        {
                            id: "userDlgDeleteBtn",
                            text: "Désinscrire",
                            click: function () {
                                holdCheckETag = true;
                                $("#confirmDeleteUserDlg").dialog('open');
                                $(this).dialog("close");
                            }
                        },
                        {
                            id: "userDlgOkBtn",
                            text: "Title will be changed dynamically",
                            click: function () {

                                let FormUser = userFromForm();

                                if (FormUser) {
                                    if (userCreateMode) {
                                        REGISTER(FormUser, firstLogin, error);
                                        $(".scrollContainer").scrollTop(0);
                                    }
                                    else {
                                        MODIFY_USER(FormUser, token, (data) => updateAfterModify(FormUser), error);
                                        resetUserForm();
                                    }
                                    holdCheckETag = false;
                                    $(this).dialog("close");
                                }

                            }
                        },
                        {
                            text: "Annuler",
                            click: function () {
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }]
                });

                $("#verifyCodeDlg").dialog({
                    title: "Vérification de courriel",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 300,
                    minWidth: 300,
                    maxWidth: 300,
                    height: 300,
                    minHeight: 300,
                    maxHeight: 500,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "verifyCodeDlgOkBtn",
                        text: "Envoyer",
                        click: function () {

                            let verifyCode = verifyCodeFromForm();
                            if (verifyCode) {

                                VERIFY((data) => getUser(userToken), error, verifyCode.Id, verifyCode.code);



                                resetVerifyCodeForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteUserDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteUserDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            let FormUser = userFromForm();
                            if (FormUser) {
                                holdCheckETag = false;
                                DELETE_USER(FormUser.Id, token, () => logoutOfAccount(false), error);
                            }
                            resetUserForm();
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
            }
        </script>

</body>

</html>