<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout">
                <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" title="Gestionnaire d'images">
                <div style="display:flex">
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>
                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-user-plus loginDiv" id="newUserCmd"  title="Créer un compte" data-toggle="tooltip"></span>




            </div>
            <div class="rightHeaderLayout">
                
                <div class="loggedDiv">
                    <span  id="modifyUserCmd"><img id="userImage" src="" alt="Image_user" ></span>
                    <span id="usernameContainer">Nom</span>
                </div>
                <span class="cmd fa-solid fa-right-to-bracket loginDiv" id="loginCmd"  title="Se connecter"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-sign-out loggedDiv" id="logoutCmd" title="Se déconnecter"  data-toggle="tooltip"></span>
            </div>
        </div>

        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
            <div>
                <div id="imageDlg">
                    <form id="imageForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="">

                        <label for="title_input">Titre</label>
                        <input type="text" id="title_input" class="form-control" required>

                        <label for="decription_input">Description</label>
                        <textarea id="description_input" class="form-control" required></textarea>

                        <label for="image">Image</label>
                        <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez une image</div>

                        <input type="checkbox" name="shared_input" id="shared_input" checked>
                        <label for="shared_input">Partager</label>
                    </form>
                </div>


                <div id="userDlg">
                    <form id="userForm">
                        <input type="hidden" id="Id_user_input" value="0">
                        <input type="hidden" id="avatar_GUID_input" value="">

                        <!--<label for="username_input">Nom d'usager</label>-->
                        <input type="text" id="username_input" class="form-control userInput" placeholder="Nom d'usager"
                            required>


                        <!--<label for="email_input ">Courriel</label>-->
                        <input type="text" id="email_input" class="form-control Email userInput" placeholder="Courriel"
                            required>

                        <!--<label for="password_input">Mot de passe</label>-->
                        <input type="password" id="password_input" placeholder="Mot de passe"
                            class="form-control MatchedPassword userInput" matchedPasswordId="passwordConfirm_input"
                            required oninvalid="this.setCustomValidity('')">

                        <!--<label for="passwordConfirm_input">Confirmation</label>-->
                        <input type="password" id="passwordConfirm_input" placeholder="Confirmation "
                            class="form-control userInput">

                        <label for="avatar">Avatar</label>
                        <div id='avatar' class='ImageUploader' defaultImage='images/No_Avatar.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez votre avatar</div>
                    </form>
                </div>

                <div id="loginDlg">
                    <form id="loginForm">
                        <label for="email_input">Courriel</label>
                        <input type="text" id="email_input_login" class="form-control" required>

                        <label for="password_input">Mot de passe</label>
                        <input type="password" id="password_input_login" class="form-control" required>

                        <input type="checkbox" name="remember_input" id="remember_input">
                        <label for="remember_input">Se souvenir de moi</label>
                    </form>
                </div>


                <div id="verifyCodeDlg">
                    <form id="verifyCodeForm">
                        Consultez votre boîte de courriel pour connaître votre code de vérification et
                        inscrivez-le-ci-dessous.

                        <input type="text" placeholder="Code de vérification" id="verify_code_input"
                            class="form-control" required>


                    </form>
                </div>

                <div id="logoutDlg">
                    <form id="logoutForm">
                        <p>Voulez-vous vraiement vous déconnecter?</p>
                    </form>
                </div>


                <div id="confirmDeleteDlg">
                    <span id="confirmationMessage"></span>
                </div>
                <div id="errorDlg">
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/api.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            const userSessionStorageName = "user";
            const loginLocalStorageName = "login";
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let searchCategory = "";
            let searchTitle = "";
            let hideSearchBar = true;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let selectedCategory = "";
            let imagesCount = 50;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let token;
            let user;
            let userToken;

            let userCreateMode = true;

            init_UI();
            initToken();

            HEAD(checkETag, error);
            setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

            function checkETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    getImagesList();
                }
            }

            function getImagesList(refresh = true) {
                appendMode = !refresh;
                function prepareQueryString() {
                    let queryString = "";
                    if (appendMode) {
                        queryString = `?sort=Date,desc&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                        imagesCount += appendCount;
                    } else {
                        queryString = `?sort=Date,desc&offset=${0}&limit=${imagesCount}`;
                    }
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
            }

            function updateUser(data) {
                if(data == user){
                    return;
                }

                user = data;
                //userToForm(data);
                sessionStorage.setItem(userSessionStorageName, JSON.stringify(user));
                $("#userImage").attr("src", data.AvatarURL);
                $("#usernameContainer").html(getUserNameSpan(data));
                
                /*
                let login = getLoginFromUser(data);
                updateRememberMe(login);
                */
            }
            function isVerified(user){
                return user.VerifyCode == "verified";
            }
            function getUserNameSpan(currentUser){
                let span = $("<span></span>")
                span.append(currentUser.Name);
                if(!isVerified(currentUser)){
                    span.addClass("unverifiedName");
                    span.click(() => $("#verifyCodeDlg").dialog('open'));
                    span.attr("data-toggle", "tooltip");
                    span.attr("title", "Votre compte n'est pas vérifié. Cliquer sur votre nom pour ouvrir le menu de confirmation de courriel.");
                }
                return span;
            }
            function updateRememberMe(login){
                if(localStorage.hasOwnProperty('login')){
                    let newLogin = JSON.parse(window.localStorage.getItem("login"));
                    if(login.Password){
                        newLogin.Password = login.Password;
                    }
                    if(login.Email){
                        newLogin.Email = login.Email;
                    }
                    window.localStorage.setItem(loginLocalStorageName, JSON.stringify(newLogin));
                }
            }
            function getLoginFromUser(user){
                let login =
                {
                    Email: user.Email,
                    Password: user.Password
                }
                return login;

            }
            function getUser(token) {
                GETUSER(token, updateUser, error);
            }

            function showLoginButtons(isLogged) {
                if (isLogged) {
                    $(".loginDiv").hide();
                    $(".loggedDiv").show();
                }
                else {
                    $(".loginDiv").show();
                    $(".loggedDiv").hide();
                }
            }

            function changeToken(newToken) {
                userToken =newToken;
                token = newToken.Access_token;
                //$("#loginDlg").dialog("close");


                sessionStorage.setItem("token", JSON.stringify(newToken));
                /*
                var isChecked = $("#remember_input").prop('checked');
                sessionStorage.setItem("token", JSON.stringify(newToken));
                if (isChecked) {
                    window.localStorage.setItem("token", JSON.stringify(newToken));
                }
                else {
                    console.log("no remember me");
                }
                */
                //rememberMe()

                resetLoginForm();
                getUser(newToken);
                showLoginButtons(true);
                getImagesList(true);
            }
            function rememberMe(login) {
                /*
                let login =
                {
                    Email: $("#email_input_login").val(),
                    Password: $("#password_input_login").val()
                }
                */
                var isChecked = $("#remember_input").is(':checked')

                if (isChecked) {
                    window.localStorage.setItem(loginLocalStorageName, JSON.stringify(login));
                }
                else {
                    window.localStorage.removeItem(loginLocalStorageName);
                }
            }
            function useRememberMe() {
                let loginFromStorage = JSON.parse(window.localStorage.getItem("login"));

                if (loginFromStorage != null) {
                    $("#email_input_login").val(loginFromStorage.Email);
                    $("#password_input_login").val(loginFromStorage.Password);
                    $("#remember_input").prop("checked", true);
                }

            }



            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image) {

                    if (image.Shared){
                        $("#imagesList").append(
                        $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                    </div>
                                    <a href="${image.OriginalURL}" target="_blank" class="imageContainer">
                                        <img class="avatarOnImage" src="${image.AvatarURL}" alt="">
                                        <div    class='image' 
                                                style="background-image:url('${image.ThumbnailURL}')"
                                                title="Image de ${image.UserName}" 
                                                data-toggle="tooltip">
                                        </div>
                                    </a>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                    );
                    }
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {
                    insertIntoImageList(image);
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { editimage(e) });
                $(".deleteCmd").click(e => { deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function newImage() {
                holdCheckETag = true;
                createMode = true;
                resetimageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }
            function logout() {
                holdCheckETag = true;
                $("#logoutDlg").dialog('option', 'title', 'Déconnexion');
                $("#logoutDlgOkBtn").text("Déconnexion");
                $("#logoutDlg").dialog('open');
            }
            function login() {
                holdCheckETag = true;

                useRememberMe();

                $("#loginDlg").dialog('option', 'title', 'Connexion');
                $("#loginDlgOkBtn").text("Connexion");
                $("#loginDlg").dialog('open');
            }
            function changeLoginToken() {
                let login =
                {
                    Email: $("#email_input_login").val(),
                    Password: $("#password_input_login").val()
                }
                rememberMe(login);
                TOKEN(login, changeToken, error);
            }

            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }
            function editUser(e) {
                holdCheckETag = true;
                userCreateMode = false;

                ImageUploader.imageRequired('avatar', true);
                $("#userDlg").dialog('option', 'title', "Modification du profil");
                $("#userDlgOkBtn").text('Modifier');
                $("#userDlg").dialog('open');

            }
            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                $("#shared_input").prop("checked", true)
                ImageUploader.resetImage('image');
            }
            function resetLoginForm() {
                $("#email_input_login").val("");
                $("#password_input_login").val("");
                $("#remember_input").prop('checked', false);
            }


            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }
            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                $("#shared_input").prop("checked", true);
                ImageUploader.resetImage('image');
            }
            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        UserId: JSON.parse(sessionStorage.getItem("token")).UserId,
                        Shared: $("#shared_input").prop("checked")
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function imageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                $("#date_input").val(image.Date);
                //$("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                ImageUploader.setImage('image', image.OriginalURL);
                //TODO shared?
            }

            function newUser() {
                holdCheckETag = true;
                userCreateMode = true;
                ImageUploader.imageRequired('avatar', true);
                $("#password_input").prop('required',true);
                $("#userDlg").dialog('option', 'title', "Création de compte");
                $("#userDlgOkBtn").text('Créer');
                $("#userDlg").dialog('open');
            }
            function modifyUser() {
                holdCheckETag = true;
                userCreateMode = false;
                userToForm(user);
                ImageUploader.imageRequired('avatar', false);
                //TODO régler problème: quand on efface le mot de passe, il est required
                $("#password_input").prop('required',false);
                $("#userDlg").dialog('option', 'title', "Modification de compte");
                $("#userDlgOkBtn").text('Modifier');
                $("#userDlg").dialog('open');
            }
            function updateAfterModify(modifiedUser){

                if(modifiedUser.Email != user.Email){
                    $("#verifyCodeDlg").dialog('open');
                }
                updateUser(modifiedUser);

                let login = getLoginFromUser(modifiedUser);
                updateRememberMe(login);

                getImagesList();
            }

            function userToForm(user) {

                $("#Id_user_input").val(user.Id);
                $("#username_input").val(user.Name);
                $("#email_input").val(user.Email);
                $("#avatar_GUID_input").val(user.AvatarGUID);

                ImageUploader.setImage('avatar', user.AvatarURL);
            }

            function userFromForm() {
                if ($("#userForm")[0].checkValidity()) {
                    let user = {
                        Id: parseInt($("#Id_user_input").val()),
                        Name: $("#username_input").val(),
                        Email: $("#email_input").val(),
                        Password: $("#password_input").val(),
                        ImageData: ImageUploader.getImageData('avatar'),
                        AvatarGUID: $("#avatar_GUID_input").val()
                    };
                    return user;
                } else {
                    $("#userForm")[0].reportValidity()
                }
                return false;
            }

            function verifyCodeFromForm() {
                if ($("#verifyCodeForm")[0].checkValidity()) {
                    let verifyCode = {
                        //Id: parseInt($("#Id_user_input").val()),
                        Id: user.Id,
                        code: parseInt($("#verify_code_input").val()),
                    };
                    return verifyCode;
                } else {
                    $("#verifyCodeForm")[0].reportValidity()
                }
                return false;
            }
            function resetUserForm() {
                $("#Id_user_input").val("0");
                $("#username_input").val("");
                $("#email_input").val("");
                $("#password_input").val("");
                $("#passwordConfirm_input").val("");
                $("#avatar_GUID_input").val("");
                ImageUploader.resetImage('avatar');
            }

            function resetVerifyCodeForm() {
                $("#verify_code_input").val("");
            }

            function firstLogin(newUserData) {
                let login =
                {
                    Email: newUserData.Email,
                    Password: $("#password_input").val()
                }
                resetUserForm();
                TOKEN(login, changeToken, error);
                //resetUserForm();
                $("#verifyCodeDlg").dialog('open');
            }

            function initToken() {
                let tokenFromSession = sessionStorage.getItem("token");
                //let userToken;
                if (tokenFromSession != null) {
                    userToken = JSON.parse(tokenFromSession);
                    if (userToken != null) {
                        token = userToken.Access_token;

                        let userFromSession = sessionStorage.getItem(userSessionStorageName);
                        if (userFromSession != null) {
                            updateUser(JSON.parse(userFromSession));
                        }
                        else {
                            getUser(userToken);
                        }
                        showLoginButtons(true);
                    }
                }


            }

            function init_UI() {
                $("#newImageCmd").click(newImage);
                $("#newUserCmd").click(newUser);
                $("#modifyUserCmd").click(modifyUser);
                $("#loginCmd").click(login);
                $("#logoutCmd").click(logout);
                //$(".loggedDiv").hide();
                showLoginButtons(false);

                //useRememberMe();



                // Images
                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effshowLoginButtonsect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            if (image) {
                                if (createMode) {
                                    POST(image, getImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else
                                    PUT(image, getImagesList, error);
                                resetimageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#loginDlg").dialog({
                    title: "Connexion",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 360,
                    minHeight: 360,
                    maxHeight: 360,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "loginDlgOkBtn",
                        text: "Login",
                        click: function () {
                            changeLoginToken();
                            //resetLoginForm();
                            $("#loginDlg").dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#logoutDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 200,
                    minHeight: 200,
                    maxHeight: 200,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "logoutDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            sessionStorage.removeItem("token");
                            sessionStorage.removeItem(userSessionStorageName);
                            //window.localStorage.setItem("token", token);
                            //TODO logout du serveur
                            resetUserForm();
                            showLoginButtons(false);
                            user = null;
                            token = null;
                            userToken = null;
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Non",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                            DELETE(imageIdToDelete, token, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        getImagesList(false);
                    }
                });


                // users
                $("#userDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500,
                    minWidth: 500,
                    maxWidth: 640,
                    height: 650,
                    minHeight: 650,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "userDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {

                            let FormUser = userFromForm();

                            if (FormUser) {
                                if (userCreateMode) {
                                    REGISTER(FormUser, firstLogin, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else {
                                    MODIFY_USER(FormUser, token, (data) => updateAfterModify(FormUser), error);
                                    resetUserForm();
                                }
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }

                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#verifyCodeDlg").dialog({
                    title: "Vérification de courriel",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 300,
                    minWidth: 300,
                    maxWidth: 300,
                    height: 300,
                    minHeight: 300,
                    maxHeight: 500,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "verifyCodeDlgOkBtn",
                        text: "Envoyer",
                        click: function () {

                            let verifyCode = verifyCodeFromForm();
                            if (verifyCode) {

                                VERIFY((data) => getUser(userToken), error, verifyCode.Id, verifyCode.code);



                                resetVerifyCodeForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }

                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
            }
        </script>

        <!--           //TODO delete user dans modify, empecher image si pas verified-->
</body>

</html>